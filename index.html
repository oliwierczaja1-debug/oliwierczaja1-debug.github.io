<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Mapa dostaw</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100vw; }
    .number-icon {
      background-color: #ff5722;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-weight: bold;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // PODSTAWOWY LINK DO CSV (ten który działa)
    const baseSheetUrl =
      "https://docs.google.com/spreadsheets/d/1LkO9jIzfLNJAYlVLGgOdZ9K4pm2WpjAa6CzmRFXbDPI/export?format=csv&gid=0";

    // jeśli korzystasz lokalnie z cors.eu.org, możesz zamiast baseSheetUrl dać:
    // const baseSheetUrl = "https://cors.eu.org/" + "TWÓJ_LINK_DO_CSV";

    const map = L.map("map").setView([48.7, 19.5], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(map);

    // warstwa, w której trzymamy WSZYSTKIE markery
    const markersLayer = L.layerGroup().addTo(map);

    function loadPoints() {
      // dodajemy parametr anty-cache, żeby za każdym razem pobierał świeży plik
      const url = baseSheetUrl + "&cacheBust=" + Date.now();

      fetch(url)
        .then(r => r.text())
        .then(text => {
          const lines = text.trim().split("\n");
          const bounds = [];

          // czyścimy stare markery
          markersLayer.clearLayers();

          lines.forEach((line, i) => {
            const nums = line.match(/-?\d+[.,]?\d*/g);
            if (!nums || nums.length < 2) return;

            // A = lat, B = lon
            const lat = parseFloat(nums[0].replace(",", "."));
            const lon = parseFloat(nums[1].replace(",", "."));
            if (isNaN(lat) || isNaN(lon)) return;

            const icon = L.divIcon({
              className: "number-icon",
              html: i + 1
            });

            const marker = L.marker([lat, lon], { icon });
            markersLayer.addLayer(marker);
            bounds.push([lat, lon]);
          });

          if (bounds.length > 0) {
            map.fitBounds(bounds);
          }
        })
        .catch(err => console.error("Błąd pobierania CSV:", err));
    }

    // pierwsze wczytanie
    loadPoints();

    // AUTO-ODŚWIEŻANIE – co 60 sekund (60000 ms)
    // możesz zmienić np. na 30000 (30 sekund) albo 120000 (2 minuty)
    setInterval(loadPoints, 60000);
  </script>
</body>
</html>
